version: '3.8'

services:
  cic-api:
    build:
      context: ./go
      dockerfile: Dockerfile
    container_name: cic-api
    environment:
      # Use host.docker.internal to connect to local Postgres
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@host.docker.internal:5432/${POSTGRES_DB:-cic_dev}?sslmode=disable
      PORT: 8080
      JWT_SECRET: ${JWT_SECRET:-your-secret-key-change-in-production}
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - cic-network

  react-admin:
    build:
      context: ./react-admin
      dockerfile: Dockerfile
    container_name: cic-react-admin
    environment:
      # API URL accessed by browser -> Gateway (localhost:80) -> Nginx -> cic-api
      VITE_API_URL: http://localhost:80/api/v1
    ports:
      - "3000:80"
    networks:
      - cic-network

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: cic-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: start-dev
    ports:
      - "8081:8080"
    networks:
      - cic-network

  nginx:
    image: nginx:alpine
    container_name: cic-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
    depends_on:
      - cic-api
      - react-admin
    networks:
      - cic-network

networks:
  cic-network:
    driver: bridge
